# SubsampleReads: An Interval Tree Based Non-Uniform Next Generation Sequencing Data Downsampling Toolkit

**Sedat Demiriz<sup>1</sup>, Daniel Taliun<sup>1</sup>**  
<sup>1</sup>Department of Human Genetics, McGill University

A Python, `pysam` based toolkit for mapping, downsampling, comparing, and plotting BAM files using BED file-defined intervals. Written for NGS data processing and compatible with HLA*LA and its PRG-remapping approach.

If you do not work with the tool HLA\*LA, you can safely ignore everything written here regarding PRG and back-mapping, how it works, and all related examples.

## Installation

1. Clone the repository:
  ```bash
  git clone https://github.com/sdemiriz/subsample-reads.git
  cd subsample-reads
  ```
2. Install dependencies (ideally in a virtual environment):
  ```bash
  pip install -r requirements.txt
  ```
3. Test run:
  ```bash
  python -m subsample_reads
  ```

## Usage:

### 1. Mapping

Divide a genomic region into intervals and count the number of reads in each interval from the provided BAM file. Outputs read count and fraction of all reads counted as BED file.

```bash
python -m subsample_reads map [options]

# Required
--in-bam BAM [BAM ...]      : One or more BAM files to map.
--contig CONTIG             : Contig name (e.g., chr6) present in all BAM files.
--start START               : Start coordinate of the mapping region.
--end END                   : End coordinate of the mapping region.

# Mutually exclusive
--interval-length LENGTH    : Specify interval size to divide the mapping region.
--interval-count COUNT      : Specify number of intervals to divide the mapping region.

# Optional
--bed-dir DIR               : Directory for output BED files (default: bed/).
--bed BED [BED ...]         : Specific BED file names (must match number of input BAM files).
```

### Example:
```bash
python -m subsample_reads map \
  --in-bam sample1.bam sample2.bam \
  --contig chr6 \
  --start 25000000 \
  --end 35000000 \
  --interval-count 10
```

### 2. Sampling

Subsample a BAM file according to a BED-defined read depth distribution, ideally a BED file generated by `map`.
```bash
python -m subsample_reads sample [options]

# Required 
--in-bam BAM              : BAM file to subsample.

# Mutually exclusive
--bed-dir DIR             : Directory to fetch a random BED file from (default: `bed/`).
--bed BED                 : Specific BED file to use for sampling.

# Optional
--seed SEED               : Random seed for reproducibility (default: 42).
--out-bam BAM             : Output BAM file (default: `out.bam`).

# HLA-LA flag
--prg [GRCh38 | GRCh37]   : Enable HLA-LA PRG-aware sampling (back-maps PRG reads to chr6 coordinates).
```

### Example (Regular sampling):
```bash
python -m subsample_reads sample \
  --in-bam sample3.bam \
  --bed bed/sample1.bed \
  --out-bam sample3-downsampled.bam
```

### Example (HLA-LA PRG mode):
```bash
python -m subsample_reads sample \
  --prg GRCh38 \
  --in-bam prg-mapped.bam \
  --bed bed/sample1.bed \
  --out-bam prg-mapped-downsampled.bam
```

---

### 4. Comparison

Compare two BAM files to check the back-mapping performance. Searches read names across the two BAM files and outputs before-and-after coordinates side by side. Performs a right join, keeping all read names from `bam-right`. Therefore, it is suggested to use the downsampled BAM for this flag.
```bash
python -m subsample_reads compare [options]

# Required
--bam-left BAM      : First BAM file.
--bam-right BAM     : Second BAM file.

# Optional
--out FILE          : Output file for overlap information (default `out.tsv`).
```

### Example:
```bash
python -m subsample_reads compare \
  --bam-left sample1.bam \
  --bam-right sample1-downsampled.bam \
  --out sample1-overlap.tsv
```

---

### 5. Plotting
Plot depth of coverage and read count in each interval from BAM and BED files via lineplot and barplot.

```bash
python -m subsample_reads plot [options]

# Required
--bed BED         : Specific BED file to determine the region to plot.

# Optional, any combination of these values is supported.
--in-bam BAM      : Input/original BAM file.
--map-bam BAM     : Mapping BAM file.
--out-bam BAM     : Subsampled BAM file.

# Optional
--out-plt PNG     : Output plot file (default: `out.png`).
--no-det          : No details (do not add interval boundaries or legend.)
```

### Example:
```bash
python -m subsample_reads plot \
  --in-bam sample1.bam \
  --map-bam sample2.bam \
  --out-bam sample1-downsampled.bam \
  --bed bed/sample2.bed \
  --out-plt sample1-plot.png
```

---

## Logging

Log files are automatically created in the `log/` directory for each command execution. Filenames contain timestamp and invoked function name. Each log file includes:

- User command line input for reproducibility
- Execution time
- Detailed error messages and stack traces (if errors occur)
- Processing status updates

## Testing

Run the `unittest` suite via 

```
python -m unittest
```

## Examples:

A Makefile is available at the repository root with example workflows.

```bash
make run-example
make run-example-prg
make algo-demo
make clean-examples
```

A Python `venv` will be created from `requirements.txt` before the tool is run. Everything produced during these steps can be found in the `examples/` directory.

The first two commands will each generate a small example BAM file, and run the full `map` -> `sample` -> `plot` core workflow and demonstrate the commands. The BAM files generated are small enough to be human readable to allow confirmation that the tool works as intended. Each read is 100 bases long with numbered names for readability and falls fully inside 10 intervals each 100 bases long.

`run-example` should produce a BAM file that contains only chr6-aligned reads with the plot outputs showing a distinct increasing staircase pattern in both coverage and read count.

`run-example-prg` should produce identical plots as `run-example` but the starting BAM file also contains a mix of PRG reads, distinguishable by their read names from chr6-aligned reads. When the tool has completed, the downsampled output should contain a mix of chr6-aligned and PRG-aligned reads from the input.

`algo-demo` will generate a minimal example with a few reads and limited scope for generating an accompanying figure. The output of this rule will list a number of read names that should match those in the figure. **Requires samtools to be available**

`clean-examples` will clean the example directory of all created files as a result of running previous commands.

### Data Download

```bash
make download-files
```
This command will download the default files for the benchmarking process. `HG002.GRCh38.300x.bam` from Genome in A Bottle (GIAB) and `HG00157.bam` from Thousand Genomes (1KG) will be downloaded (>500GB total). **HG00157 is downloaded in CRAM format and is then converted to BAM format and indexed using `samtools` and thus the availability of `samtools` is a requirement.**

## Benchmarks

```bash
make single-interval
make multi-interval
make clean-benchmarks
```

The `benchmarks/` directory contains benchmark scripts that compares `subsample-reads` against uniform downsampling tools in a single- or multi-interval scenarios.

The default values benchmark performance in a padded HLA region (chr6:25000000-35000000) using a single interval or 1000 intervals. These coordinates and values can be tweaked easily for further benchmarking using the top-level variables in each script.

Results are saved to `benchmarks/single-interval-benchmark.txt` and `benchmarks/multi-interval-benchmark.txt` respectively, with timing and memory usage statistics.

## Publication

The `publication/` directory contains scripts and data for generating publication figures.

```bash
make figure-1
```

Generates the underlying plots for figure 1 comparing `subsample-reads` non-uniform downsampling with samtools on HLA region. Produces `figure-1.png` and `figure-1-samtools.png` in the same directory as the script.


## Future

* Provide BED templates to `map` that contain interval coordinates but not read counts as a "proto-template" that can then be filled out. An example use case would be a scenario when intron and exon regions that are not regularly spaced in the genome that could be downsampled.

* Expand the BED template format to be able to accommodate multiple chromosomal regions or the ability to provide multiple BED templates at the same time and produce a final downsampled BAM file that contains the compbined outputs of all downsamplings.

* Tweaks to output file handling where a "prefix" (destination directory, filename start) can be defined and multiple outputs that share the "prefix" can be produced without needing to be explicitly named at the command line. (I think PLINK does this already?) This can help split the `plot` outputs into separate files among other uses.

* Multi/parallel processing of parts of BAM files to speed up processing.

* Optimize read-interval overlap searching using `numpy` array based approaches rather than base Python looping.

* Add warning or handling for intervals of lesser length than the read length of the files used.

---
