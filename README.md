# subsample-reads Toolkit

A Python toolkit for mapping, subsampling, comparing, and plotting BAM files using BED-defined intervals. Written for bioinformatics  high-throughput sequencing data and compatible with HLA*LA and its PRG-remapping approach.

If you do not work with HLA-LA, you can safely ignore everything written here regarding HLA-LA, how it works, and all related examples.

## Installation

1. Clone the repository:
   ```bash
   git clone https://github.com/sdemiriz/subsample-reads.git
   cd subsample-reads
   ```
2. Install dependencies (ideally in a virtual environment):
   ```bash
   pip install -r requirements.txt
   ```

## Prepared examples:

### Preflight

Activate environment if already set up
```
source venv/bin/activate
```

### 1. Mapping

```
python -m subsample_reads map --in-bam MISSING.bam --contig MISSING --start MISSING --end MISSING --interval-count MISSING
```

### 2. Sampling

TODO: add a version of HLA-LA sampling without running the flag, showing the difference between including PRG reads and not
```
# Regular sampling
python -m subsample_reads sample --in-bam examples/example.bam --bed examples/example.bed --out-bam examples/example-out.bam

# HLA-LA sampling
python -m subsample_reads sample --prg GRCh38 --in-bam examples/example-prg.bam --bed examples/example-prg.bed --out-bam examples/example-prg-out.bam
```

### 3. Plotting

In both cases, running the command should produce `example-out.png` where a stairlike pattern of increasing coverage should be visible for the processed BAM file in contrast to the original flat coverage of input BAM file.
```
# Regular plot
python -m subsample_reads plot --in-bam examples/example.bam --map-bam --out-bam examples/example-out.bam --bed examples/example.bed --out-plt examples/example-out.png

# HLA-LA plot
python -m subsample_reads plot --in-bam examples/example-prg.bam --map-bam --out-bam examples/example-prg-out.bam --bed examples/example-prg.bed --out-plt examples/example-prg-out.png
```

## Usage:

## Subcommands

### 1. Mapping

Divide a genomic region into intervals and count the number of reads in each interval from the provided BAM file. Outputs read count and fraction of all reads counted as BED file.
```bash
python -m subsample_reads map [options]

# Required
--in-bam BAM [BAM ...]      : One or more BAM files to map.
--contig CONTIG             : Contig name (e.g., chr6) present in all BAM files.
--start START               : Start coordinate of the mapping region.
--end END                   : End coordinate of the mapping region.

# Mutually exclusive
--interval-length LENGTH    : Specify interval size to divide the mapping region.
--interval-count COUNT      : Specify number of intervals to divide the mapping region.

# Optional
--bed-dir DIR               : Output directory for BED files (default: bed/).
```

**Example:**
```bash
python -m subsample_reads map \
  --in-bam sample1.bam sample2.bam \
  --contig chr6 --start 25000000 --end 35000000 \
  --interval-count 10
```

### 2. Sampling

Subsample a BAM file according to a BED-defined read depth distribution, ideally a BED file generated by `map`.
```bash
python -m subsample_reads sample [options]

# Required 
--in-bam BAM              : BAM file to subsample.

# Mutually exclusive
--bed-dir DIR             : Directory to fetch a random BED file from (default: `bed/`).
--bed BED                 : Specific BED file to use for sampling.

# Optional
--seed SEED               : Random seed for reproducibility (default: 42).
--out-bam BAM             : Output BAM file (default: `out.bam`).

# HLA-LA flag
--prg [GRCh37 | GRCh37]   : Enable HLA-LA PRG mode for sampling (back-maps PRG reads to chr6 coordinates).
```

**Example (Regular sampling):**
```bash
python -m subsample_reads sample \
  --in-bam sample1.bam \
  --bed bed/sample1.bed \
  --out-bam subsampled.bam
```

**Example (HLA-LA PRG mode):**
```bash
python -m subsample_reads sample \
  --prg GRCh38 \
  --in-bam remapped_with_a.bam \
  --bed bed/sample1.bed \
  --out-bam prg-subsampled.bam
```

---

### 4. Comparison

Compare two BAM files to check the back-mapping performance. Searches read names across the two BAM files and outputs before-and-after coordinates side by side. Performs a right join, keeping all read names from `bam_right`. Therefore, it is suggested to use the smaller of the two BAMs for this value.
```bash
python -m subsample_reads compare [options]

# Required
--bam_left BAM      : First BAM file.
--bam_right BAM     : Second BAM file.

# Optional
--out FILE          : Output file for overlap information (default `out.tsv`).
```

**Example:**
```bash
python -m subsample_reads compare \
  --bam_left sample1.bam \
  --bam_right sample2.bam \
  --out overlap.tsv
```

---

### 5. Plotting
Plot read depth and interval coverage from BAM and BED files. Visualize coverage and read distribution across intervals.

```bash
python -m subsample_reads plot [options]

# Optional
--in-bam BAM      : Input/original BAM file.
--map-bam BAM     : Mapping BAM file.
--sub-bam BAM     : Subsampled BAM file.
--bed BED         : Specific BED file to determine the region to plot.

# Optional
--out-plt PNG     : Output plot file (default: `out.png`).
```

**Example:**
```bash
python -m subsample_reads plot \
  --in-bam sample1.bam \
  --map-bam sample2.bam \
  --sub-bam subsampled.bam \
  --bed bed/sample1.bed \
  --out-plt coverage.png
```

---

## Logging

Timestamped log files are written to the `log/` directory for each run.

## Testing

Run the `unittest` suite via 

```
python -m unittest
```
