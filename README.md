# SubsampleReads: An Interval Tree Based Non-Uniform Next Generation Sequencing Data Downsampling Toolkit

**Sedat Demiriz<sup>1</sup>, Daniel Taliun<sup>1</sup>**  
<sup>1</sup>Department of Human Genetics, McGill University

A Python, `pysam` based toolkit for mapping, downsampling, comparing, and plotting BAM files using BED file-defined intervals. Written for NGS data processing and compatible with HLA*LA and its PRG-remapping approach.

If you do not work with the tool HLA\*LA, you can safely ignore everything written here regarding PRG and back-mapping, how it works, and all related examples.

## Installation

1. Clone the repository:
  ```bash
  git clone https://github.com/sdemiriz/subsample-reads.git
  cd subsample-reads
  ```
2. Install dependencies (ideally in a virtual environment):
  ```bash
  pip install -r requirements.txt
  ```
3. Test run:
  ```bash
  python -m subsample_reads
  ```

## Prepared examples:

A demo Makefile is available at the repository root with example workflows.

```bash
make run-example
make run-example-prg
make algo-demo
```

A Python `venv` will be created from `requirements.txt` before the tool is run. Everything produced during these steps is contained in the `examples/` directory.

The first two will each generate a BAM file, and run the full `map` -> `sample` -> `plot` core workflow and demonstrate the commands. The BAM files generated are small enough to be human readable to allow confirmation that the tool works as intended. Each read is 100 bases long with numbered names for easy reading and falls fully inside 10 intervals each 100 bases long.

`run-example` should produce a BAM file that contains only chr6-aligned reads with the plot outputs showing a distinct increasing staircase pattern in both coverage and read count.

`run-example-prg` should produce identical plots as `run-example` but the starting BAM file also contains a mix of PRG reads, distinguishable by their read names from chr6-aligned reads. When the tool has completed, the downsampled output should contain a mix of chr6-aligned and PRG-aligned reads from the input.

`algo-demo` will generate a minimal example with a few reads and limited scope for generating an accompanying figure. The output of this rule will list a number of read names that should match those in the figure. **Requires samtools to be available**

Other available commands:
```
make all      : Run all rules from above
make clean    : Delete created BAM, BED files and plot images.
```


## Usage:

### 1. Mapping

Divide a genomic region into intervals and count the number of reads in each interval from the provided BAM file. Outputs read count and fraction of all reads counted as BED file.

```bash
python -m subsample_reads map [options]

# Required
--in-bam BAM [BAM ...]      : One or more BAM files to map.
--contig CONTIG             : Contig name (e.g., chr6) present in all BAM files.
--start START               : Start coordinate of the mapping region.
--end END                   : End coordinate of the mapping region.

# Mutually exclusive
--interval-length LENGTH    : Specify interval size to divide the mapping region.
--interval-count COUNT      : Specify number of intervals to divide the mapping region.

# Optional
--bed-dir DIR               : Directory for output BED files (default: bed/).
```

### Example:
```bash
python -m subsample_reads map \
  --in-bam sample1.bam sample2.bam \
  --contig chr6 \
  --start 25000000 \
  --end 35000000 \
  --interval-count 10
```

### 2. Sampling

Subsample a BAM file according to a BED-defined read depth distribution, ideally a BED file generated by `map`.
```bash
python -m subsample_reads sample [options]

# Required 
--in-bam BAM              : BAM file to subsample.

# Mutually exclusive
--bed-dir DIR             : Directory to fetch a random BED file from (default: `bed/`).
--bed BED                 : Specific BED file to use for sampling.

# Optional
--seed SEED               : Random seed for reproducibility (default: 42).
--out-bam BAM             : Output BAM file (default: `out.bam`).

# HLA-LA flag
--prg [GRCh38 | GRCh37]   : Enable HLA-LA PRG-aware sampling (back-maps PRG reads to chr6 coordinates).
```

### Example (Regular sampling):
```bash
python -m subsample_reads sample \
  --in-bam sample3.bam \
  --bed bed/sample1.bed \
  --out-bam sample3-downsampled.bam
```

### Example (HLA-LA PRG mode):
```bash
python -m subsample_reads sample \
  --prg GRCh38 \
  --in-bam prg-mapped.bam \
  --bed bed/sample1.bed \
  --out-bam prg-mapped-downsampled.bam
```

---

### 4. Comparison

Compare two BAM files to check the back-mapping performance. Searches read names across the two BAM files and outputs before-and-after coordinates side by side. Performs a right join, keeping all read names from `bam-right`. Therefore, it is suggested to use the downsampled BAM for this flag.
```bash
python -m subsample_reads compare [options]

# Required
--bam-left BAM      : First BAM file.
--bam-right BAM     : Second BAM file.

# Optional
--out FILE          : Output file for overlap information (default `out.tsv`).
```

### Example:
```bash
python -m subsample_reads compare \
  --bam_left sample1.bam \
  --bam_right sample1-downsampled.bam \
  --out sample1-overlap.tsv
```

---

### 5. Plotting
Plot depth of coverage and read count in each interval from BAM and BED files via lineplot and barplot.

```bash
python -m subsample_reads plot [options]

# Required
--bed BED         : Specific BED file to determine the region to plot.

# Optional, any combination of these values is supported.
--in-bam BAM      : Input/original BAM file.
--map-bam BAM     : Mapping BAM file.
--out-bam BAM     : Subsampled BAM file.

# Optional
--out-plt PNG     : Output plot file (default: `out.png`).
```

### Example:
```bash
python -m subsample_reads plot \
  --in-bam sample1.bam \
  --map-bam sample2.bam \
  --out-bam sample1-downsampled.bam \
  --bed bed/sample2.bed \
  --out-plt sample1-plot.png
```

---

## Logging

Log files are written to the `log/` directory for each run. Filenames contain timestamp and name of invoked command.

## Testing

Run the `unittest` suite via 

```
python -m unittest
```
