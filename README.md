# subsample-reads Toolkit

A Python toolkit for mapping, subsampling, comparing, and plotting BAM files using BED-defined intervals. Written for bioinformatics  high-throughput sequencing data and compatible with HLA*LA and its PRG-remapping approach.

## Installation

1. Clone the repository:
   ```bash
   git clone https://github.com/sdemiriz/subsample-reads.git
   cd subsample-reads
   ```
2. Install dependencies (ideally in a virtual environment):
   ```bash
   pip install -r requirements.txt
   ```

## Usage:

## Subcommands

### 1. Mapping

Divide a genomic region into intervals and count the number of reads in each interval. Output read count and fraction of all reads counted as BED file.
```bash
python -m subsample_reads map [options]

# Required
--in-bam BAM [BAM ...]      : One or more BAM files to map.
--contig CONTIG             : Contig name (e.g., chr6) present in all BAM files.
--start START               : Start coordinate of the region to map.
--end END                   : End coordinate of the region to map.

# Mutually exclusive
--interval-length LENGTH    : Specify interval size.
--interval-count COUNT      : Specify number of intervals.

# Optional
--bed-dir DIR               : Output directory for BED files (default: bed/).
```

**Example:**
```bash
python -m subsample_reads map \
  --in-bam sample1.bam sample2.bam \
  --contig chr6 --start 25000000 --end 35000000 \
  --interval-count 10
```

### 2. Sampling

Subsample a BAM file according to a BED-defined read depth distribution, ideally a BED file generated by `map`.
```bash
python -m subsample_reads sample [options]

# Required 
--in-bam BAM        : BAM file to subsample.

# Optional
--bed-dir DIR       : Directory to fetch BED files from (default: `bed/`).
--bed BED           : Specific BED file to use for sampling.
--seed SEED         : Random seed for reproducibility (default: 42).
--out-bam BAM       : Output BAM file (default: `out.bam`).
--prg               : Enable HLA-LA PRG mode for sampling (back-maps PRG-mapped reads to chr6 coordinates).
```

**Example (Regular sampling):**
```bash
python -m subsample_reads sample \
  --in-bam sample1.bam \
  --bed bed/sample1.bed \
  --out-bam subsampled.bam
```

**Example (HLA-LA PRG mode):**
```bash
python -m subsample_reads sample \
  --prg \
  --in-bam remapped_with_a.bam \
  --bed bed/sample1.bed \
  --out-bam prg-subsampled.bam
```

---

### 3. HLA*LA-specific Sampling

First, map back to chr6 HLA*LA PRG-mapped reads and a BED file, then subsample as normal.
```bash
python -m subsample_reads hlala [options]

# Required
--hlala-dir DIR     : Path to HLA*LA setup directory (default: `HLA-LA/`).
--sampleID ID       : HLA*LA processed sample ID.
--prg VERSION       : GRCh38 or GRCh37 values supported.

# Optional
--bed-dir DIR       : Directory to fetch BED files from (default: `bed/`).
--bed BED           : Specific BED file to use for sampling.
--seed SEED         : Random seed (default: 42).
--out-bam BAM       : Output BAM file (default: `out.bam`).
```

**Example:**
```bash
python -m subsample_reads hlala \
  --hlala-dir HLA-LA/ \
  --sampleID HG00157 \
  --bed bed/sample1.bed \
  --seed 02836 \
  --out-bam hlala-subsampled.bam
```

---

### 4. Comparison

Compare two BAM files to check the back-mapping performance. Searches read names across the two BAM files and outputs before-and-after coordinates side by side. Performs a right join, keeping all read names from `bam_right`. Therefore, it is suggested to use the smaller of the two BAMs for this value.
```bash
python -m subsample_reads compare [options]

# Required
--bam_left BAM      : First BAM file.
--bam_right BAM     : Second BAM file.
--out FILE          : Output file for overlap information (tab-delimited).
```

**Example:**
```bash
python -m subsample_reads compare \
  --bam_left sample1.bam \
  --bam_right sample2.bam \
  --out overlap.tsv
```

---

### 5. Plotting
Plot read depth and interval coverage from BAM and BED files. Visualize coverage and read distribution across intervals.

```bash
python -m subsample_reads plot [options]

# Required
--in-bam BAM        : Input/original BAM file.
--map-bam BAM       : Mapping BAM file.
--sub-bam BAM       : Subsampled BAM file.

# Optional
--bed-dir DIR       : Directory to fetch a random BED file from (default: `bed/`).
--bed BED           : Specific BED file to plot.
--out-plt PNG       : Output plot file (default: `out.png`).
```

**Example:**
```bash
python -m subsample_reads plot \
  --in-bam sample1.bam \
  --map-bam sample2.bam \
  --sub-bam subsampled.bam \
  --bed bed/sample1.bed \
  --out-plt coverage.png
```

---

## Logging

Timestamped log files are written to the `log/` directory for each run.

## Testing

Run the `unittest` suite via 

```
python -m unittest
```
